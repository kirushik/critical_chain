<% page_title! "Manage Shares - #{@estimation.title}" %>

<div class="container">
  <h1 class="title">Manage Shares</h1>
  <h2 class="subtitle"><%= @estimation.title %></h2>

  <div class="columns">
    <div class="column is-half">
      <div class="box">
        <h3 class="title is-4">Share this Estimation</h3>
        
        <%= form_with model: [@estimation, EstimationShare.new], local: true do |form| %>
          <div class="field">
            <%= form.label :shared_with_email, "Email Address", class: "label" %>
            <div class="control">
              <%= form.email_field :shared_with_email, class: "input", placeholder: "user@example.com", required: true %>
            </div>
            <p class="help">
              Enter the email address of the person you want to share with. 
              If they haven't signed up yet, they'll get access when they sign in with this email.
            </p>
          </div>

          <div class="field">
            <%= form.label :role, "Access Level", class: "label" %>
            <div class="control">
              <div class="select">
                <%= form.select :role, [['Viewer (read-only)', 'viewer'], ['Owner (can edit)', 'owner']], {}, { class: "select" } %>
              </div>
            </div>
            <p class="help">Viewers can only view the estimation. Owners can edit it.</p>
          </div>

          <div class="field">
            <div class="control">
              <%= form.submit "Share", class: "button is-primary" %>
              <%= link_to "Back to Estimation", estimation_path(@estimation), class: "button" %>
            </div>
          </div>
        <% end %>
      </div>
    </div>

    <div class="column is-half">
      <div class="box">
        <h3 class="title is-4">Current Shares</h3>
        
        <% if @estimation_shares.any? %>
          <div id="shares_list">
            <table class="table is-fullwidth is-hoverable">
              <thead>
                <tr>
                  <th>Email</th>
                  <th>Status</th>
                  <th>Role</th>
                  <th>Last Accessed</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody>
                <% @estimation_shares.each do |share| %>
                  <tr id="<%= dom_id(share) %>">
                    <td><%= share.display_email %></td>
                    <td>
                      <% if share.pending? %>
                        <span class="tag is-warning">Pending</span>
                      <% else %>
                        <span class="tag is-success">Active</span>
                      <% end %>
                    </td>
                    <td>
                      <span class="tag <%= share.owner? ? 'is-info' : '' %>">
                        <%= share.role.titleize %>
                      </span>
                    </td>
                    <td>
                      <% if share.last_accessed_at %>
                        <%= time_ago_in_words(share.last_accessed_at) %> ago
                      <% else %>
                        <span class="has-text-grey-light">Never</span>
                      <% end %>
                    </td>
                    <td>
                      <%= button_to "Revoke", estimation_estimation_share_path(@estimation, share), 
                          method: :delete, 
                          class: "button is-small is-danger",
                          data: { confirm: "Are you sure you want to revoke access for #{share.display_email}?" } %>
                      
                      <% if current_user.id == @estimation.user_id && share.active? %>
                        <%= button_to "Transfer Ownership", transfer_ownership_estimation_estimation_share_path(@estimation, share),
                            method: :post,
                            class: "button is-small is-warning",
                            data: { confirm: "Are you sure you want to transfer ownership to #{share.display_email}? You will become a viewer." } %>
                      <% end %>
                    </td>
                  </tr>
                <% end %>
              </tbody>
            </table>
          </div>
        <% else %>
          <p class="has-text-grey-light">This estimation has not been shared with anyone yet.</p>
        <% end %>
      </div>
    </div>
  </div>
</div>
